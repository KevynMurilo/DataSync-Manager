<div class="w-full">
  <div class="flex flex-wrap justify-between items-center gap-4 mb-6">
    <h1 class="text-3xl font-bold text-gray-900 dark:text-gray-100">Dashboard</h1>
  </div>

  <ng-container *ngIf="data$ | async as data; else loadingTpl">
    <div class="space-y-6">

      <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-6">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700">
          <div class="flex items-center gap-4">
            <span class="material-icons-outlined text-3xl text-blue-500">schedule</span>
            <div>
              <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Total de Jobs</p>
              <p class="text-3xl font-bold text-gray-900 dark:text-gray-100">{{ data.stats.totalJobs }}</p>
            </div>
          </div>
        </div>
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700">
          <div class="flex items-center gap-4">
            <span class="material-icons-outlined text-3xl text-blue-500">dns</span>
            <div>
              <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Fontes de Dados</p>
              <p class="text-3xl font-bold text-gray-900 dark:text-gray-100">{{ data.stats.totalSources }}</p>
            </div>
          </div>
        </div>
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700">
          <div class="flex items-center gap-4">
            <span class="material-icons-outlined text-3xl text-blue-500">storage</span>
            <div>
              <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Destinos</p>
              <p class="text-3xl font-bold text-gray-900 dark:text-gray-100">{{ data.stats.totalDestinations }}</p>
            </div>
          </div>
        </div>
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700">
          <div class="flex items-center gap-4">
            <span class="material-icons-outlined text-3xl text-green-500">check_circle</span>
            <div>
              <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Taxa de Sucesso</p>
              <p class="text-3xl font-bold text-gray-900 dark:text-gray-100">{{ data.stats.successRatePercentage | number:'1.0-1' }}%</p>
            </div>
          </div>
        </div>
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700">
          <div class="flex items-center gap-4">
            <span class="material-icons-outlined text-3xl text-gray-500">save</span>
            <div>
              <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Espaço Usado</p>
              <p class="text-3xl font-bold text-gray-900 dark:text-gray-100">{{ formatBytes(data.stats.totalStorageUsedBytes) }}</p>
            </div>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        
        <div class="bg-white dark:bg-gray-800 rounded-lg overflow-hidden border border-red-200 dark:border-red-700/50 shadow-lg">
          <div class="flex items-center gap-3 px-6 py-5 border-b border-gray-200 dark:border-gray-700">
            <span class="material-icons-outlined text-red-500 dark:text-red-400">error_outline</span>
            <h2 class="text-lg font-semibold text-gray-900 dark:text-gray-100">Falhas Recentes</h2>
          </div>
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
              <thead class="bg-gray-50 dark:bg-gray-700">
                <tr>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Job</th>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Data</th>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Resumo do Erro</th>
                </tr>
              </thead>
              <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                <tr *ngIf="data.recentFailures.length === 0">
                  <td colspan="3" class="px-6 py-10 text-center text-sm text-gray-500 dark:text-gray-400">
                    Nenhuma falha recente encontrada.
                  </td>
                </tr>
                <tr *ngFor="let record of data.recentFailures" class="hover:bg-gray-50 dark:hover:bg-gray-700/50">
                  <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white">{{ record.job.name || 'N/A' }}</td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600 dark:text-gray-300">{{ record.timestamp | date:'dd/MM/yy HH:mm' }}</td>
                  <td class="px-6 py-4 text-sm text-red-600 dark:text-red-400 truncate max-w-sm" [title]="record.logSummary">{{ record.logSummary }}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="bg-white dark:bg-gray-800 rounded-lg overflow-hidden border border-gray-200 dark:border-gray-700 shadow-lg">
          <div class="flex items-center gap-3 px-6 py-5 border-b border-gray-200 dark:border-gray-700">
            <span class="material-icons-outlined text-gray-500 dark:text-gray-400">update</span>
            <h2 class="text-lg font-semibold text-gray-900 dark:text-gray-100">Próximos Jobs Agendados</h2>
          </div>
          <ul class="divide-y divide-gray-200 dark:divide-gray-700">
            <li *ngIf="data.upcomingJobs.length === 0" class="px-6 py-4 text-center text-sm text-gray-500 dark:text-gray-400">
              Nenhum job agendado para hoje.
            </li>
            <li *ngFor="let job of data.upcomingJobs" class="px-6 py-4 flex justify-between items-center">
              <div>
                <p class="text-sm font-medium text-gray-900 dark:text-white">{{ job.name }}</p>
                <p class="text-sm text-gray-500 dark:text-gray-400">{{ job.source.name }}</p>
              </div>
              <span class="text-sm font-bold text-gray-900 dark:text-gray-100">{{ job.backupTime }}</span>
            </li>
          </ul>
        </div>
        
        <div class="bg-white dark:bg-gray-800 rounded-lg overflow-hidden border border-gray-200 dark:border-gray-700 shadow-lg">
          <div class="flex items-center gap-3 px-6 py-5 border-b border-gray-200 dark:border-gray-700">
            <span class="material-icons-outlined text-gray-500 dark:text-gray-400">pie_chart</span>
            <h2 class="text-lg font-semibold text-gray-900 dark:text-gray-100">Espaço por Fonte</h2>
          </div>
          <ul class="divide-y divide-gray-200 dark:divide-gray-700">
            <li *ngIf="data.storageBySource.length === 0" class="px-6 py-4 text-center text-sm text-gray-500 dark:text-gray-400">
              Nenhum dado de armazenamento.
            </li>
            <li *ngFor="let source of data.storageBySource" class="px-6 py-4 flex justify-between items-center">
              <p class="text-sm font-medium text-gray-900 dark:text-white">{{ source.sourceName }}</p>
              <span class="text-sm font-medium text-gray-700 dark:text-gray-200">{{ formatBytes(source.totalBytes) }}</span>
            </li>
          </ul>
        </div>

        <div class="bg-white dark:bg-gray-800 rounded-lg overflow-hidden border border-gray-200 dark:border-gray-700 shadow-lg">
          <div class="flex items-center gap-3 px-6 py-5 border-b border-gray-200 dark:border-gray-700">
            <span class="material-icons-outlined text-gray-500 dark:text-gray-400">bar_chart</span>
            <h2 class="text-lg font-semibold text-gray-900 dark:text-gray-100">Backups (Últimos 7 dias)</h2>
          </div>
          <ul class="divide-y divide-gray-200 dark:divide-gray-700">
            <li *ngIf="data.dailyStatusSummary.length === 0" class="px-6 py-4 text-center text-sm text-gray-500 dark:text-gray-400">
              Nenhum backup executado.
            </li>
            <li *ngFor="let day of data.dailyStatusSummary" class="px-6 py-4 flex justify-between items-center">
              <p class="text-sm font-medium text-gray-900 dark:text-white">{{ day.date | date:'dd/MM' }}</p>
              <div class="flex gap-4">
                <span class="text-sm font-medium text-green-600 dark:text-green-400">{{ day.successCount }} S</span>
                <span class="text-sm font-medium text-red-600 dark:text-red-400">{{ day.failedCount }} F</span>
              </div>
            </li>
          </ul>
        </div>
      </div>

      <div class="bg-white dark:bg-gray-800 rounded-lg overflow-hidden border border-gray-200 dark:border-gray-700 shadow-lg">
        <div class="flex items-center gap-3 px-6 py-5 border-b border-gray-200 dark:border-gray-700">
          <span class="material-icons-outlined text-gray-500 dark:text-gray-400">history</span>
          <h2 class="text-lg font-semibold text-gray-900 dark:text-gray-100">Histórico de Execuções Recentes</h2>
        </div>
    
        <ng-container *ngIf="historyPage$ | async as page">
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
              <thead class="bg-gray-50 dark:bg-gray-700">
                <tr>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Status</th>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Job</th>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Data</th>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Tamanho</th>
                  <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Ações</th>
                </tr>
              </thead>
              <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                <tr *ngIf="page.empty">
                  <td colspan="5" class="px-6 py-10 text-center text-sm text-gray-500 dark:text-gray-400">
                    Nenhum registro de backup encontrado.
                  </td>
                </tr>
                <tr *ngFor="let record of page.content" class="hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors duration-100">
                  <td class="px-6 py-4 whitespace-nowrap">
                    <span
                      class="px-2.5 py-0.5 inline-flex text-xs leading-5 font-semibold rounded-md"
                      [ngClass]="{
                        'bg-green-100 text-green-800 dark:bg-green-800 dark:text-green-100': record.status === BackupStatus.SUCCESS,
                        'bg-red-100 text-red-800 dark:bg-red-800 dark:text-red-100': record.status === BackupStatus.FAILED,
                        'bg-yellow-100 text-yellow-800 dark:bg-yellow-800 dark:text-yellow-100': record.status === BackupStatus.IN_PROGRESS
                      }"
                    >
                      {{ record.status }}
                    </span>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white">{{ record.job.name || 'N/A' }}</td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600 dark:text-gray-300">{{ record.timestamp | date:'dd/MM/yyyy HH:mm:ss' }}</td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600 dark:text-gray-300">{{ (record.sizeBytes / 1024 / 1024) | number:'1.2-2' }} MB</td>
                  <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                    
                    <button *ngIf="record.status === BackupStatus.IN_PROGRESS"
                      (click)="openLogModal(record.job.id)"
                      class="font-medium text-yellow-600 hover:text-yellow-800 dark:text-yellow-400 dark:hover:text-yellow-300 transition-colors duration-150">
                      Ver Log
                    </button>
                    
                    <button *ngIf="record.status === BackupStatus.SUCCESS"
                      (click)="restore(record.id)"
                      class="font-medium text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 disabled:text-gray-400 disabled:cursor-not-allowed transition-colors duration-150">
                      Restaurar
                    </button>

                    <span *ngIf="record.status === BackupStatus.FAILED" class="font-medium text-red-600 dark:text-red-400">
                      Falhou
                    </span>

                  </td>
                </tr>
              </tbody>
            </table>
          </div>
    
          <div class="px-6 py-4 border-t border-gray-200 dark:border-gray-700 flex items-center justify-between">
            <div class="text-sm text-gray-600 dark:text-gray-400">
              Exibindo {{ page.numberOfElements }} de {{ page.totalElements }} registros
            </div>
            <div class="flex gap-2">
              <button
                (click)="loadHistory(page.number - 1)"
                [disabled]="page.first"
                class="px-4 py-2 text-sm font-medium text-gray-700 bg-white dark:bg-gray-700 dark:text-gray-200 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm hover:bg-gray-50 dark:hover:bg-gray-600 disabled:opacity-50"
              >
                Anterior
              </button>
              <button
                (click)="loadHistory(page.number + 1)"
                [disabled]="page.last"
                class="px-4 py-2 text-sm font-medium text-gray-700 bg-white dark:bg-gray-700 dark:text-gray-200 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm hover:bg-gray-50 dark:hover:bg-gray-600 disabled:opacity-50"
              >
                Próximo
              </button>
            </div>
          </div>
        </ng-container>
      </div>

    </div>
  </ng-container>

  <ng-template #loadingTpl>
    <div class="flex justify-center items-center h-96">
      <span class="material-icons-outlined text-5xl text-gray-400 animate-spin">sync</span>
    </div>
  </ng-template>
</div>

<app-modal [isVisible]="isLogModalVisible" (onClose)="closeLogModal()">
  <app-log-viewer
    *ngIf="isLogModalVisible"
    [jobId]="selectedJobIdForLogs!"
    (onClose)="closeLogModal()">
  </app-log-viewer>
</app-modal>